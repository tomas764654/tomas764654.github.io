<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Random 1-on-1 Chat</title>
<style>
  body { font-family: Arial; display: flex; flex-direction: column; align-items: center; padding: 20px; }
  #chat { width: 350px; height: 400px; border: 1px solid #ccc; overflow-y: auto; margin-bottom: 10px; padding: 5px; }
  #message { width: 250px; }
  button { margin: 5px; }
</style>
</head>
<body>

<h2>Random 1-on-1 Chat</h2>

<div id="chat"></div>
<input type="text" id="message" placeholder="Type a message..." disabled>
<button id="sendBtn" disabled>Send</button>
<button id="joinBtn">Join Chat</button>
<button id="leaveBtn" disabled>Leave</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, set, push, onChildAdded, get, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBKPnvKO_FeQv-HEJ_TFkE0IM_Z4Gcexfo",
    authDomain: "chat-system-cd559.firebaseapp.com",
    databaseURL: "https://chat-system-cd559-default-rtdb.firebaseio.com/",
    projectId: "chat-system-cd559",
    storageBucket: "chat-system-cd559.appspot.com",
    messagingSenderId: "116950973794",
    appId: "1:116950973794:web:a711054cead143cf92c03b",
    measurementId: "G-QV4T0G2BVN"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let chatId = null;
  const userId = 'user_' + Math.floor(Math.random() * 100000);

  const chatDiv = document.getElementById('chat');
  const messageInput = document.getElementById('message');
  const sendBtn = document.getElementById('sendBtn');
  const joinBtn = document.getElementById('joinBtn');
  const leaveBtn = document.getElementById('leaveBtn');

  function appendMessage(msg) {
    chatDiv.innerHTML += msg + '<br>';
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  async function joinChat() {
    const waitingSnap = await get(ref(db, 'waiting'));
    const waitingChats = waitingSnap.val();

    if(waitingChats) {
      const firstKey = Object.keys(waitingChats)[0];
      chatId = firstKey;
      await remove(ref(db, 'waiting/' + chatId));
      await set(ref(db, 'chats/' + chatId), { users: { [userId]: true }, messages: {} });
    } else {
      chatId = 'chat_' + Math.floor(Math.random() * 100000);
      await set(ref(db, 'waiting/' + chatId), { [userId]: true });
      appendMessage("Waiting for a stranger...");
      return;
    }

    appendMessage("You are connected to a stranger!");
    joinBtn.disabled = true;
    leaveBtn.disabled = false;
    sendBtn.disabled = false;
    messageInput.disabled = false;

    listenMessages();
  }

  function listenMessages() {
    const messagesRef = ref(db, 'chats/' + chatId + '/messages');
    onChildAdded(messagesRef, (snapshot) => {
      const msg = snapshot.val();
      if(msg.user !== userId){
        appendMessage('Stranger: ' + msg.text);
      }
    });
  }

  function sendMessage() {
    const text = messageInput.value.trim();
    if(!text || !chatId) return;

    const msgRef = push(ref(db, 'chats/' + chatId + '/messages'));
    set(msgRef, { user: userId, text });
    appendMessage('You: ' + text);
    messageInput.value = '';
  }

  async function leaveChat() {
    if(chatId){
      await remove(ref(db, 'chats/' + chatId));
      chatId = null;
      chatDiv.innerHTML = '';
      joinBtn.disabled = false;
      leaveBtn.disabled = true;
      sendBtn.disabled = true;
      messageInput.disabled = true;
    }
  }

  joinBtn.onclick = joinChat;
  sendBtn.onclick = sendMessage;
  messageInput.addEventListener('keypress', e => { if(e.key === 'Enter') sendMessage(); });
  leaveBtn.onclick = leaveChat;

</script>

</body>
</html>
